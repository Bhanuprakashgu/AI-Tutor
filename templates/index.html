<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - Advanced Learning Companion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { max-width: 1200px; width: 100%; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; text-align: center; }
        .tab-nav { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; overflow-x: auto; }
        .tab-button { flex: 1; min-width: 120px; padding: 15px 20px; background: none; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; transition: all 0.3s ease; position: relative; }
        .tab-button:hover { background: rgba(79, 172, 254, 0.1); color: #4facfe; }
        .tab-button.active { color: #4facfe; background: white; }
        .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: #4facfe; }
        .tab-content { display: none; padding: 30px; min-height: 600px; }
        .tab-content.active { display: block; }
        .mascot-container { display: flex; justify-content: center; align-items: center; padding: 40px 20px; background: #f8f9fa; position: relative; border-radius: 15px; margin-bottom: 20px; }
        .mascot { width: 200px; height: 200px; border-radius: 50%; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.5s ease; cursor: pointer; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .mascot.speaking { animation: speaking-bounce 0.6s infinite alternate; background: linear-gradient(45deg, #4facfe, #00f2fe); box-shadow: 0 0 40px rgba(79, 172, 254, 0.6); }
        .mascot.listening { animation: listening-pulse 1.5s infinite; background: linear-gradient(45deg, #28a745, #20c997); box-shadow: 0 0 50px rgba(40, 167, 69, 0.8); }
        .mascot.thinking { animation: thinking-wobble 2s infinite; background: linear-gradient(45deg, #fd7e14, #ffc107); }
        .mascot.happy { background: linear-gradient(45deg, #ff6b6b, #ffa726); animation: happy-bounce 1s infinite; }
        .mascot.excited { background: linear-gradient(45deg, #e91e63, #ff5722); animation: excited-shake 0.5s infinite; }
        .mascot.confused { background: linear-gradient(45deg, #9c27b0, #673ab7); animation: confused-tilt 1.5s infinite; }
        .mascot.sad { background: linear-gradient(45deg, #607d8b, #455a64); animation: sad-droop 2s infinite; }
        .mascot.surprised { background: linear-gradient(45deg, #ff9800, #ffeb3b); animation: surprised-jump 0.8s infinite; }
        .face { font-size: 60px; transition: all 0.3s ease; position: relative; z-index: 2; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .emotion-indicator { position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.8); }
        .mascot-eyes { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 1; }
        .eye { width: 20px; height: 20px; background: white; border-radius: 50%; position: relative; }
        .pupil { width: 10px; height: 10px; background: #333; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: all 0.3s ease; }
        .mascot.listening .pupil { animation: eye-listen 2s infinite; }
        .mascot.speaking .pupil { animation: eye-speak 0.6s infinite; }
        .mascot.thinking .pupil { animation: eye-think 1s infinite; }
        .sound-waves { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .wave { position: absolute; border: 2px solid rgba(255, 255, 255, 0.6); border-radius: 50%; }
        .mascot.speaking .wave { animation: sound-wave 1s infinite; }
        .wave:nth-child(1) { width: 220px; height: 220px; margin: -110px 0 0 -110px; animation-delay: 0s; }
        .wave:nth-child(2) { width: 260px; height: 260px; margin: -130px 0 0 -130px; animation-delay: 0.3s; }
        .wave:nth-child(3) { width: 300px; height: 300px; margin: -150px 0 0 -150px; animation-delay: 0.6s; }
        .controls { text-align: center; margin-bottom: 20px; }
        .control-row { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .mic-button { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(45deg, #ff6b6b, #ee5a52); border: none; color: white; font-size: 25px; cursor: pointer; transition: all 0.3s ease; }
        .mic-button:hover { transform: translateY(-3px); }
        .mic-button.recording { background: linear-gradient(45deg, #ff4757, #c44569); animation: recording-pulse 1s infinite; }
        .mute-button { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, #28a745, #20c997); border: none; color: white; font-size: 20px; cursor: pointer; transition: all 0.3s ease; margin-left: 10px; }
        .mute-button.muted { background: linear-gradient(45deg, #dc3545, #fd7e14); }
        .mute-button:hover { transform: translateY(-2px); }
        .text-input { width: 100%; max-width: 400px; padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 25px; font-size: 14px; margin: 10px; outline: none; transition: all 0.3s ease; }
        .text-input:focus { border-color: #4facfe; }
        .send-button { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; margin: 10px; }
        .send-button:hover { transform: translateY(-2px); }
        .chat-area { max-height: 300px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 15px; border: 1px solid #e9ecef; }
        .message { margin: 15px 0; padding: 12px 18px; border-radius: 20px; max-width: 80%; animation: message-appear 0.3s ease; }
        .user-message { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; margin-left: auto; text-align: right; }
        .ai-message { background: #ffffff; color: #333; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .status { text-align: center; padding: 15px; font-style: italic; color: #666; background: rgba(255, 255, 255, 0.8); border-radius: 10px; margin: 10px 0; transition: all 0.3s ease; }
        .status.processing { background: linear-gradient(45deg, #ffd89b, #19547b); color: white; animation: processing 1.5s infinite; }
        .upload-area { border: 3px dashed #4facfe; border-radius: 15px; padding: 40px; text-align: center; margin-bottom: 30px; transition: all 0.3s ease; cursor: pointer; }
        .upload-area:hover { background: rgba(79, 172, 254, 0.05); }
        .file-input { display: none; }
        .upload-button { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; margin: 10px; }
        .document-list { background: #f8f9fa; border-radius: 15px; padding: 20px; }
        .document-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .document-info { flex: 1; }
        .document-name { font-weight: bold; color: #333; }
        .document-meta { font-size: 12px; color: #666; margin-top: 5px; }
        .delete-button { background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .quiz-controls { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
        .quiz-input-group { display: flex; flex-direction: column; gap: 10px; }
        .quiz-input { padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; outline: none; }
        .generate-button { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; align-self: flex-end; }
        .quiz-timer { text-align: center; font-size: 18px; color: #4facfe; margin: 20px 0; font-weight: bold; }
        .quiz-container { background: #f8f9fa; border-radius: 15px; padding: 20px; }
        .question-item { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .question-text { font-weight: bold; color: #333; margin-bottom: 15px; font-size: 16px; }
        .option { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .option:hover { background: #e9ecef; }
        .option.selected { background: #4facfe; color: white; border-color: #4facfe; }
        .option.correct { background: #28a745; color: white; border-color: #28a745; }
        .option.incorrect { background: #dc3545; color: white; border-color: #dc3545; }
        .correct-answer { color: #28a745; font-weight: bold; margin-top: 10px; display: none; }
        .explanation { color: #666; font-style: italic; margin-top: 10px; display: none; }
        .quiz-actions { text-align: center; margin: 20px 0; }
        .submit-quiz-button { background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; margin: 10px; }
        .quiz-score { text-align: center; padding: 20px; background: white; border-radius: 15px; margin: 20px 0; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); }
        .score-display { font-size: 48px; font-weight: bold; color: #4facfe; margin-bottom: 10px; }
        .score-text { font-size: 18px; color: #666; }
        .study-topic-input { width: 100%; max-width: 400px; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; margin-bottom: 20px; outline: none; }
        .timer-display { font-size: 48px; font-weight: bold; color: #4facfe; text-align: center; margin: 30px 0; font-family: 'Courier New', monospace; }
        .timer-controls { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .timer-button { padding: 15px 30px; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .start-button { background: linear-gradient(45deg, #28a745, #20c997); color: white; }
        .stop-button { background: linear-gradient(45deg, #dc3545, #fd7e14); color: white; }
        .study-history { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 30px; }
        .study-session { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .progress-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .progress-card { background: white; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .progress-card:hover { transform: translateY(-5px); }
        .progress-number { font-size: 36px; font-weight: bold; color: #4facfe; margin-bottom: 10px; }
        .progress-label { color: #666; font-size: 14px; font-weight: 500; }
        .recent-activity { background: #f8f9fa; border-radius: 15px; padding: 20px; }
        .activity-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .activity-icon.document { background: #4facfe; }
        .activity-icon.quiz { background: #28a745; }
        .activity-icon.study { background: #fd7e14; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes glow { 0% { box-shadow: 0 0 20px rgba(78, 205, 196, 0.3); } 50% { box-shadow: 0 0 50px rgba(78, 205, 196, 0.9); } 100% { box-shadow: 0 0 20px rgba(78, 205, 196, 0.3); } }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes speaking-bounce { 0% { transform: scale(1) translateY(0px); } 100% { transform: scale(1.08) translateY(-5px); } }
        @keyframes listening-pulse { 0% { transform: scale(1); box-shadow: 0 0 20px rgba(40, 167, 69, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 60px rgba(40, 167, 69, 1); } 100% { transform: scale(1); box-shadow: 0 0 20px rgba(40, 167, 69, 0.4); } }
        @keyframes thinking-wobble { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }
        @keyframes happy-bounce { 0%, 100% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-8px) scale(1.05); } }
        @keyframes excited-shake { 0% { transform: translateX(0px) rotate(0deg); } 25% { transform: translateX(-3px) rotate(-1deg); } 50% { transform: translateX(3px) rotate(1deg); } 75% { transform: translateX(-2px) rotate(-0.5deg); } 100% { transform: translateX(0px) rotate(0deg); } }
        @keyframes confused-tilt { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(8deg); } 75% { transform: rotate(-8deg); } }
        @keyframes sad-droop { 0%, 100% { transform: translateY(0px) scale(1); } 50% { transform: translateY(5px) scale(0.98); } }
        @keyframes surprised-jump { 0%, 100% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-12px) scale(1.1); } }
        @keyframes eye-listen { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-30%, -50%) scale(1.2); } }
        @keyframes eye-speak { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -30%) scale(0.8); } }
        @keyframes eye-think { 0%, 100% { transform: translate(-50%, -50%); } 25% { transform: translate(-70%, -30%); } 75% { transform: translate(-30%, -70%); } }
        @keyframes sound-wave { 0% { opacity: 1; transform: scale(0.8); } 100% { opacity: 0; transform: scale(1.2); } }
        @keyframes recording-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); } }
        @keyframes message-appear { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes processing { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        @media (max-width: 768px) { .container { margin: 10px; } .mascot { width: 150px; height: 150px; } .face { font-size: 40px; } .tab-nav { flex-wrap: wrap; } .tab-button { min-width: 100px; font-size: 12px; padding: 12px 15px; } .progress-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .quiz-controls { flex-direction: column; align-items: center; } .timer-display { font-size: 36px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 AI Tutor - Advanced Learning Companion</h1>
            <p>RAG-Powered • Speech Recognition • Document Processing • Quiz Generation • Study Tracking</p>
        </div>

        <div class="tab-nav">
            <button class="tab-button active" onclick="showTab('chat')">💬 Chat</button>
            <button class="tab-button" onclick="showTab('documents')">📚 Documents</button>
            <button class="tab-button" onclick="showTab('quiz')">❓ Quiz</button>
            <button class="tab-button" onclick="showTab('study')">⏱️ Study</button>
            <button class="tab-button" onclick="showTab('progress')">📈 Progress</button>
        </div>

        <div id="chat" class="tab-content active">
            <div class="mascot-container">
                <div class="mascot" id="mascot">
                    <div class="mascot-eyes">
                        <div class="eye"><div class="pupil"></div></div>
                        <div class="eye"><div class="pupil"></div></div>
                    </div>
                    <div class="face" id="face">🤖</div>
                    <div class="sound-waves">
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                    </div>
                    <div class="emotion-indicator" id="emotionIndicator">Ready</div>
                </div>
            </div>
            <div class="controls">
                <div class="control-row">
                    <button class="mic-button" id="micButton" title="Click and speak">🎤</button>
                    <button class="mute-button" id="muteButton" title="Toggle speech output">🔊</button>
                </div>
                <div class="control-row">
                    <input type="text" class="text-input" id="textInput" placeholder="Ask me anything...">
                    <button class="send-button" id="sendButton">Send</button>
                </div>
            </div>
            <div class="status" id="status">Click the microphone to start speaking or type your question!</div>
            <div class="chat-area" id="chatArea"></div>
        </div>

        <div id="documents" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">📚 Document Management</h2>
            <div class="upload-area" id="uploadArea">
                <div style="font-size: 48px; margin-bottom: 20px;">📄</div>
                <h3>Upload Documents</h3>
                <p style="color: #666; margin: 10px 0;">Drag and drop files here or click to browse</p>
                <p style="color: #999; font-size: 12px;">Supported formats: PDF, DOCX, TXT</p>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.txt" multiple>
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">Choose Files</button>
            </div>
            <div class="document-list">
                <h3 style="margin-bottom: 15px; color: #333;">Uploaded Documents</h3>
                <div id="documentsList">
                    <p style="text-align: center; color: #666; padding: 20px;">No documents uploaded yet</p>
                </div>
            </div>
        </div>

        <div id="quiz" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">❓ Quiz Generation</h2>
            <div class="quiz-controls">
                <div class="quiz-input-group">
                    <label for="quizTopic">Topic:</label>
                    <input type="text" id="quizTopic" class="quiz-input" placeholder="Enter topic (e.g., Mathematics, Science, History)">
                </div>
                <div class="quiz-input-group">
                    <label for="numQuestions">Number of Questions:</label>
                    <select id="numQuestions" class="quiz-input">
                        <option value="5">5 Questions</option>
                        <option value="10">10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                    </select>
                </div>
                <button class="generate-button" id="generateQuizButton" onclick="generateQuiz()">Generate Quiz</button>
            </div>
            <div class="quiz-timer" id="quizTimer" style="display: none;"></div>
            <div class="quiz-container" id="quizContainer" style="display: none;">
                <div id="quizQuestions"></div>
                <div class="quiz-actions">
                    <button class="submit-quiz-button" id="submitQuizButton" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
                </div>
                <div class="quiz-score" id="quizScore" style="display: none;">
                    <div class="score-display" id="scoreDisplay">0/0</div>
                    <div class="score-text" id="scoreText">Your Score</div>
                </div>
            </div>
            <div class="recent-activity" style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #333;">Recent Quizzes</h3>
                <div id="quizHistory">
                    <p style="text-align: center; color: #666; padding: 20px;">No quizzes generated yet</p>
                </div>
            </div>
        </div>

        <div id="study" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">⏱️ Study Timer</h2>
            <div style="text-align: center; margin-bottom: 30px;">
                <input type="text" id="studyTopic" class="study-topic-input" placeholder="What are you studying today?">
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-button start-button" id="startTimerButton" onclick="startStudyTimer()">Start Study Session</button>
                    <button class="timer-button stop-button" id="stopTimerButton" onclick="stopStudyTimer()" disabled>Stop Session</button>
                </div>
            </div>
            <div class="study-history">
                <h3 style="margin-bottom: 15px; color: #333;">Study History</h3>
                <div id="studyHistory">
                    <p style="text-align: center; color: #666; padding: 20px;">No study sessions yet</p>
                </div>
            </div>
        </div>

        <div id="progress" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">📈 Learning Progress</h2>
            <div class="progress-grid" id="progressGrid">
                <div class="progress-card">
                    <div class="progress-number" id="documentsCount">0</div>
                    <div class="progress-label">Documents Uploaded</div>
                </div>
                <div class="progress-card">
                    <div class="progress-number" id="quizzesCount">0</div>
                    <div class="progress-label">Quizzes Generated</div>
                </div>
                <div class="progress-card">
                    <div class="progress-number" id="studySessionsCount">0</div>
                    <div class="progress-label">Study Sessions</div>
                </div>
                <div class="progress-card">
                    <div class="progress-number" id="conversationsCount">0</div>
                    <div class="progress-label">Conversations</div>
                </div>
                <div class="progress-card">
                    <div class="progress-number" id="studyTimeTotal">00:00:00</div>
                    <div class="progress-label">Total Study Time</div>
                </div>
                <div class="progress-card">
                    <div class="progress-number" id="topicsCount">0</div>
                    <div class="progress-label">Topics Studied</div>
                </div>
            </div>
            <div class="recent-activity">
                <h3 style="margin-bottom: 15px; color: #333;">Recent Activity</h3>
                <div id="recentActivity">
                    <p style="text-align: center; color: #666; padding: 20px;">No recent activity</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class EnhancedAITutor {
            constructor() {
                this.isRecording = false;
                this.isMuted = false;
                this.currentStudySession = null;
                this.studyStartTime = null;
                this.studyTimer = null;
                this.currentQuizId = null;
                this.quizAnswers = {};
                
                this.mascot = document.getElementById('mascot');
                this.face = document.getElementById('face');
                this.emotionIndicator = document.getElementById('emotionIndicator');
                this.status = document.getElementById('status');
                this.chatArea = document.getElementById('chatArea');
                this.textInput = document.getElementById('textInput');
                this.micButton = document.getElementById('micButton');
                this.muteButton = document.getElementById('muteButton');
                this.sendButton = document.getElementById('sendButton');
                
                this.initializeEventListeners();
                this.loadProgress();
            }

            initializeEventListeners() {
                // Chat functionality
                this.micButton.addEventListener('click', () => this.toggleRecording());
                this.muteButton.addEventListener('click', () => this.toggleMute());
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.textInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                // Document upload
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');
                
                fileInput.addEventListener('change', (e) => this.uploadDocuments(e.target.files));
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = 'rgba(79, 172, 254, 0.1)';
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.background = '';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.background = '';
                    this.uploadDocuments(e.dataTransfer.files);
                });
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const muteButton = document.getElementById('muteButton');
                
                if (this.isMuted) {
                    muteButton.classList.add('muted');
                    muteButton.innerHTML = '🔇';
                    muteButton.title = 'Unmute speech output';
                    this.status.textContent = 'Speech output muted - responses will be text only';
                    
                    // Stop any ongoing speech synthesis
                    if ('speechSynthesis' in window) {
                        speechSynthesis.cancel();
                        // Reset mascot state if it was speaking
                        if (this.mascot.classList.contains('speaking')) {
                            this.setMascotState('ready', '🤖', 'Ready');
                        }
                    }
                } else {
                    muteButton.classList.remove('muted');
                    muteButton.innerHTML = '🔊';
                    muteButton.title = 'Mute speech output';
                    this.status.textContent = 'Speech output enabled - responses will be spoken and shown as text';
                }
            }

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                    if (this.recognition) {
                        this.recognition.stop();
                    }
                } else {
                    this.startRecording();
                }
            }

            startRecording() {
                this.isRecording = true;
                this.micButton.classList.add('recording');
                this.setMascotState('listening', '👂', 'Listening...');
                this.status.textContent = 'Listening... Speak now!';
                
                // Start speech recognition
                this.recognizeSpeech();
            }

            stopRecording() {
                this.isRecording = false;
                this.micButton.classList.remove('recording');
                this.setMascotState('ready', '🤖', 'Ready');
                this.status.textContent = 'Processing your speech...';
            }

            setMascotState(state, emoji, emotion) {
                // Remove all state classes
                this.mascot.classList.remove('speaking', 'listening', 'thinking', 'happy', 'excited', 'confused', 'sad', 'surprised');
                
                // Add new state class if not ready
                if (state !== 'ready') {
                    this.mascot.classList.add(state);
                }
                
                // Update face and emotion
                this.face.textContent = emoji;
                this.emotionIndicator.textContent = emotion;
            }

            setMascotEmotion(emotion) {
                const emotions = {
                    'happy': { emoji: '😊', class: 'happy', text: 'Happy' },
                    'excited': { emoji: '🤩', class: 'excited', text: 'Excited' },
                    'confused': { emoji: '😕', class: 'confused', text: 'Confused' },
                    'sad': { emoji: '😢', class: 'sad', text: 'Sad' },
                    'surprised': { emoji: '😲', class: 'surprised', text: 'Surprised' },
                    'thinking': { emoji: '🤔', class: 'thinking', text: 'Thinking' },
                    'speaking': { emoji: '🗣️', class: 'speaking', text: 'Speaking' },
                    'listening': { emoji: '👂', class: 'listening', text: 'Listening' }
                };
                
                if (emotions[emotion]) {
                    this.setMascotState(emotions[emotion].class, emotions[emotion].emoji, emotions[emotion].text);
                }
            }

            analyzeMessageEmotion(message) {
                const lowerMessage = message.toLowerCase();
                
                // Simple emotion detection based on keywords
                if (lowerMessage.includes('happy') || lowerMessage.includes('great') || lowerMessage.includes('awesome') || lowerMessage.includes('wonderful')) {
                    return 'happy';
                } else if (lowerMessage.includes('excited') || lowerMessage.includes('amazing') || lowerMessage.includes('fantastic')) {
                    return 'excited';
                } else if (lowerMessage.includes('confused') || lowerMessage.includes('don\'t understand') || lowerMessage.includes('unclear')) {
                    return 'confused';
                } else if (lowerMessage.includes('sad') || lowerMessage.includes('disappointed') || lowerMessage.includes('upset')) {
                    return 'sad';
                } else if (lowerMessage.includes('wow') || lowerMessage.includes('really') || lowerMessage.includes('surprising')) {
                    return 'surprised';
                } else {
                    return 'ready';
                }
            }

            async recognizeSpeech() {
                try {
                    // Use Web Speech API for speech recognition
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        this.recognition = new SpeechRecognition();
                        const recognition = this.recognition;
                        
                        recognition.continuous = true;
                        recognition.interimResults = false;
                        recognition.lang = 'en-US';
                        
                        recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            this.textInput.value = transcript;
                            // Do not stop recording automatically
                            // this.stopRecording();
                            this.sendMessage();
                        };
                        
                        recognition.onerror = (event) => {
                            console.error('Speech recognition error:', event.error);
                            this.stopRecording();
                            this.status.textContent = 'Speech recognition failed. Please try typing instead.';
                        };
                        
                        recognition.onend = () => {
                            // Only stop recording if not explicitly stopped by button
                            // if (this.isRecording) {
                            //     this.stopRecording();
                            // }
                        };
                        
                        recognition.start();
                    } else {
                        this.stopRecording();
                        this.status.textContent = 'Speech recognition not supported in this browser. Please type your message.';
                    }
                } catch (error) {
                    console.error('Speech recognition error:', error);
                    this.stopRecording();
                    this.status.textContent = 'Speech recognition failed. Please try typing instead.';
                }
            }

            async sendMessage() {
                const message = this.textInput.value.trim();
                if (!message) return;

                // Clear input
                this.textInput.value = '';
                
                // Add user message to chat
                this.addMessage(message, 'user');
                
                // Analyze message emotion and show appropriate mascot reaction
                const detectedEmotion = this.analyzeMessageEmotion(message);
                if (detectedEmotion !== 'ready') {
                    this.setMascotEmotion(detectedEmotion);
                    setTimeout(() => {
                        this.setMascotState('thinking', '🤔', 'Thinking...');
                    }, 1500);
                } else {
                    this.setMascotState('thinking', '🤔', 'Thinking...');
                }
                
                this.status.classList.add('processing');
                this.status.textContent = 'Processing your question...';

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Add AI response to chat
                    this.addMessage(data.response, 'ai');
                    
                    // Speak the response if not muted
                    if (!this.isMuted) {
                        this.speakText(data.response);
                    } else {
                        // If muted, show happy emotion briefly
                        this.setMascotEmotion('happy');
                        setTimeout(() => {
                            this.setMascotState('ready', '🤖', 'Ready');
                        }, 2000);
                    }

                } catch (error) {
                    console.error('Chat error:', error);
                    this.addMessage('Sorry, I encountered an error processing your request. Please try again.', 'ai');
                    this.setMascotEmotion('sad');
                    setTimeout(() => {
                        this.setMascotState('ready', '🤖', 'Ready');
                    }, 2000);
                } finally {
                    this.status.classList.remove('processing');
                    this.status.textContent = 'Ready for your next question!';
                }
            }

            async speakText(text) {
                try {
                    // Check if muted before starting
                    if (this.isMuted) {
                        return;
                    }
                    
                    // Show speaking state
                    this.setMascotState('speaking', '🗣️', 'Speaking...');
                    
                    // Use Web Speech API for text-to-speech
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = 0.9;
                        utterance.pitch = 1;
                        utterance.volume = 0.8;
                        
                        // Try to use a female voice if available
                        const voices = speechSynthesis.getVoices();
                        const femaleVoice = voices.find(voice => 
                            voice.name.toLowerCase().includes('female') || 
                            voice.name.toLowerCase().includes('zira') ||
                            voice.name.toLowerCase().includes('samantha')
                        );
                        if (femaleVoice) {
                            utterance.voice = femaleVoice;
                        }
                        
                        utterance.onend = () => {
                            // Only show happy emotion if not muted (speech completed naturally)
                            if (!this.isMuted) {
                                this.setMascotEmotion('happy');
                                setTimeout(() => {
                                    this.setMascotState('ready', '🤖', 'Ready');
                                }, 1500);
                            }
                        };
                        
                        utterance.onstart = () => {
                            // Double-check if muted when speech actually starts
                            if (this.isMuted) {
                                speechSynthesis.cancel();
                                this.setMascotState('ready', '🤖', 'Ready');
                            }
                        };
                        
                        // Store reference to current utterance for potential cancellation
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    } else {
                        // Fallback: try server-side TTS
                        await fetch('/api/speech/synthesize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: text })
                        });
                        
                        setTimeout(() => {
                            if (!this.isMuted) {
                                this.setMascotEmotion('happy');
                                setTimeout(() => {
                                    this.setMascotState('ready', '🤖', 'Ready');
                                }, 1500);
                            }
                        }, 3000);
                    }
                } catch (error) {
                    console.error('TTS error:', error);
                    this.setMascotEmotion('confused');
                    setTimeout(() => {
                        this.setMascotState('ready', '🤖', 'Ready');
                    }, 2000);
                }
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.textContent = text;
                this.chatArea.appendChild(messageDiv);
                this.chatArea.scrollTop = this.chatArea.scrollHeight;
            }

            async uploadDocuments(files) {
                if (!files || files.length === 0) return;

                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }

                this.status.classList.add('processing');
                this.status.textContent = 'Uploading and processing documents...';

                try {
                    const response = await fetch('/api/documents/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (data.results) {
                        const successCount = data.results.filter(r => !r.error).length;
                        this.status.textContent = `Successfully uploaded ${successCount} document(s)`;
                        this.loadDocuments();
                        this.loadProgress();
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    this.status.textContent = 'Document upload failed. Please try again.';
                } finally {
                    this.status.classList.remove('processing');
                    document.getElementById('fileInput').value = '';
                }
            }

            async loadDocuments() {
                try {
                    const response = await fetch('/api/documents');
                    const data = await response.json();
                    const documentsList = document.getElementById('documentsList');
                    
                    if (data.documents && data.documents.length > 0) {
                        documentsList.innerHTML = data.documents.map(doc => `
                            <div class="document-item">
                                <div class="document-info">
                                    <div class="document-name">${doc.original_name}</div>
                                    <div class="document-meta">
                                        Uploaded: ${new Date(doc.upload_date).toLocaleDateString()} • 
                                        Size: ${(doc.file_size / 1024).toFixed(1)} KB
                                    </div>
                                </div>
                                <button class="delete-button" onclick="aiTutor.deleteDocument('${doc.id}')">Delete</button>
                            </div>
                        `).join('');
                    } else {
                        documentsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No documents uploaded yet</p>';
                    }
                } catch (error) {
                    console.error('Error loading documents:', error);
                }
            }

            async deleteDocument(docId) {
                if (!confirm('Are you sure you want to delete this document?')) return;

                try {
                    const response = await fetch(`/api/documents/${docId}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (data.success) {
                        this.loadDocuments();
                        this.loadProgress();
                        this.status.textContent = 'Document deleted successfully';
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    this.status.textContent = 'Failed to delete document';
                }
            }

            async generateQuiz() {
                const topic = document.getElementById('quizTopic').value.trim();
                const numQuestions = document.getElementById('numQuestions').value;
                const generateButton = document.getElementById('generateQuizButton');
                const timerElement = document.getElementById('quizTimer');

                if (!topic) {
                    alert('Please enter a topic for the quiz');
                    return;
                }

                generateButton.disabled = true;
                generateButton.textContent = 'Generating...';
                timerElement.style.display = 'block';
                timerElement.textContent = 'Generating quiz questions...';

                try {
                    const response = await fetch('/api/quiz/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic: topic, num_questions: parseInt(numQuestions) })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    this.currentQuizId = data.quiz_id;
                    this.quizAnswers = {};
                    this.displayQuiz(data.questions, data.topic);
                    this.loadQuizHistory();
                    this.loadProgress();
                    
                    timerElement.textContent = 'Quiz generated successfully!';
                    setTimeout(() => { timerElement.style.display = 'none'; }, 3000);
                } catch (error) {
                    console.error('Quiz generation error:', error);
                    timerElement.textContent = 'Failed to generate quiz. Please try again.';
                    setTimeout(() => { timerElement.style.display = 'none'; }, 3000);
                } finally {
                    generateButton.disabled = false;
                    generateButton.textContent = 'Generate Quiz';
                }
            }

            displayQuiz(questions, topic) {
                const quizContainer = document.getElementById('quizContainer');
                const questionsDiv = document.getElementById('quizQuestions');
                const submitButton = document.getElementById('submitQuizButton');
                const scoreDiv = document.getElementById('quizScore');
                
                // Reset quiz state
                scoreDiv.style.display = 'none';
                submitButton.style.display = 'block';
                
                questionsDiv.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #4facfe;">Quiz: ${topic}</h3>
                    ${questions.map((q, index) => `
                        <div class="question-item" data-question="${index}">
                            <div class="question-text">${q.question}</div>
                            ${q.options.map((option, optionIndex) => `
                                <div class="option" data-option="${option}" onclick="aiTutor.selectOption(${index}, '${option}', this)">
                                    ${option}
                                </div>
                            `).join('')}
                            <div class="correct-answer">Correct Answer: ${q.correct}</div>
                            <div class="explanation">${q.explanation || ''}</div>
                        </div>
                    `).join('')}
                `;
                quizContainer.style.display = 'block';
            }

            selectOption(questionIndex, option, element) {
                // Remove previous selection for this question
                const questionDiv = element.closest('.question-item');
                questionDiv.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Mark current selection
                element.classList.add('selected');
                this.quizAnswers[questionIndex] = option;
            }

            async submitQuiz() {
                if (!this.currentQuizId) {
                    alert('No active quiz found');
                    return;
                }

                const submitButton = document.getElementById('submitQuizButton');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                try {
                    const response = await fetch('/api/quiz/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quiz_id: this.currentQuizId,
                            answers: this.quizAnswers
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    this.showQuizResults(data);
                    this.revealAnswers(data.detailed_results);
                    
                } catch (error) {
                    console.error('Quiz submission error:', error);
                    alert('Failed to submit quiz. Please try again.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Quiz';
                }
            }

            showQuizResults(results) {
                const scoreDiv = document.getElementById('quizScore');
                const scoreDisplay = document.getElementById('scoreDisplay');
                const scoreText = document.getElementById('scoreText');
                const submitButton = document.getElementById('submitQuizButton');
                
                scoreDisplay.textContent = `${results.score}/${results.total}`;
                scoreText.textContent = `Your Score: ${results.percentage.toFixed(1)}%`;
                
                // Color code the score
                if (results.percentage >= 80) {
                    scoreDisplay.style.color = '#28a745';
                } else if (results.percentage >= 60) {
                    scoreDisplay.style.color = '#fd7e14';
                } else {
                    scoreDisplay.style.color = '#dc3545';
                }
                
                scoreDiv.style.display = 'block';
                submitButton.style.display = 'none';
            }

            revealAnswers(detailedResults) {
                detailedResults.forEach((result, index) => {
                    const questionDiv = document.querySelector(`[data-question="${index}"]`);
                    if (questionDiv) {
                        // Show correct answer and explanation
                        const correctAnswerDiv = questionDiv.querySelector('.correct-answer');
                        const explanationDiv = questionDiv.querySelector('.explanation');
                        
                        correctAnswerDiv.style.display = 'block';
                        if (explanationDiv && result.explanation) {
                            explanationDiv.style.display = 'block';
                        }
                        
                        // Color code the options
                        questionDiv.querySelectorAll('.option').forEach(option => {
                            const optionText = option.getAttribute('data-option');
                            if (optionText === result.correct_answer) {
                                option.classList.add('correct');
                            } else if (optionText === result.user_answer && !result.is_correct) {
                                option.classList.add('incorrect');
                            }
                        });
                    }
                });
            }

            async loadQuizHistory() {
                try {
                    const response = await fetch('/api/quiz/history');
                    const data = await response.json();
                    const quizHistory = document.getElementById('quizHistory');
                    if (data.quizzes && data.quizzes.length > 0) {
                        quizHistory.innerHTML = data.quizzes.map(quiz => `
                            <div class="study-session">
                                <div>
                                    <strong>${quiz.topic}</strong><br>
                                    <small>${quiz.num_questions} questions • ${new Date(quiz.created_date).toLocaleDateString()}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        quizHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No quizzes generated yet</p>';
                    }
                } catch (error) {
                    console.error('Error loading quiz history:', error);
                }
            }

            async startStudyTimer() {
                const topic = document.getElementById('studyTopic').value.trim();
                if (!topic) { alert('Please enter what you are studying'); return; }
                try {
                    const response = await fetch('/api/study/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic: topic })
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.currentStudySession = data.session_id;
                        this.studyStartTime = new Date();
                        document.getElementById('startTimerButton').disabled = true;
                        document.getElementById('stopTimerButton').disabled = false;
                        document.getElementById('studyTopic').disabled = true;
                        this.studyTimer = setInterval(() => { this.updateTimerDisplay(); }, 1000);
                        this.status.textContent = `Study session started for: ${topic}`;
                    } else {
                        alert(data.error || 'Failed to start study session');
                    }
                } catch (error) {
                    alert('Failed to start study session: Connection error');
                }
            }

            async stopStudyTimer() {
                if (!this.currentStudySession) return;
                try {
                    const response = await fetch(`/api/study/stop/${this.currentStudySession}`, { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        clearInterval(this.studyTimer);
                        this.studyTimer = null;
                        this.currentStudySession = null;
                        document.getElementById('startTimerButton').disabled = false;
                        document.getElementById('stopTimerButton').disabled = true;
                        document.getElementById('studyTopic').disabled = false;
                        document.getElementById('studyTopic').value = '';
                        document.getElementById('timerDisplay').textContent = '00:00:00';
                        this.status.textContent = `Study session completed! Duration: ${data.duration_formatted}`;
                        this.loadStudyHistory();
                        this.loadProgress();
                    } else {
                        alert(data.error || 'Failed to stop study session');
                    }
                } catch (error) {
                    alert('Failed to stop study session: Connection error');
                }
            }

            updateTimerDisplay() {
                if (!this.studyStartTime) return;
                const now = new Date();
                const elapsed = Math.floor((now - this.studyStartTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timerDisplay').textContent = display;
            }

            async loadStudyHistory() {
                try {
                    const response = await fetch('/api/study/sessions');
                    const data = await response.json();
                    const studyHistory = document.getElementById('studyHistory');
                    if (data.sessions && data.sessions.length > 0) {
                        studyHistory.innerHTML = data.sessions.map(session => `
                            <div class="study-session">
                                <div>
                                    <strong>${session.topic}</strong><br>
                                    <small>${new Date(session.start_time).toLocaleDateString()} • ${session.duration_formatted}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        studyHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No study sessions yet</p>';
                    }
                } catch (error) {
                    console.error('Error loading study history:', error);
                }
            }

            async loadProgress() {
                try {
                    const response = await fetch('/api/progress');
                    const data = await response.json();
                    document.getElementById('documentsCount').textContent = data.documents_uploaded || 0;
                    document.getElementById('quizzesCount').textContent = data.quizzes_generated || 0;
                    document.getElementById('studySessionsCount').textContent = data.study_sessions || 0;
                    document.getElementById('conversationsCount').textContent = data.conversations || 0;
                    document.getElementById('studyTimeTotal').textContent = data.total_study_time_formatted || '00:00:00';
                    document.getElementById('topicsCount').textContent = data.topics_studied ? data.topics_studied.length : 0;
                    const recentActivity = document.getElementById('recentActivity');
                    if (data.recent_activity && data.recent_activity.length > 0) {
                        recentActivity.innerHTML = data.recent_activity.map(activity => `
                            <div class="activity-item">
                                <div class="activity-icon ${activity.type}">
                                    ${activity.type === 'document' ? '📄' : activity.type === 'quiz' ? '❓' : '⏱️'}
                                </div>
                                <div>
                                    <strong>${activity.name}</strong><br>
                                    <small>${new Date(activity.date).toLocaleDateString()}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        recentActivity.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No recent activity</p>';
                    }
                } catch (error) {
                    console.error('Error loading progress:', error);
                }
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); });
            document.querySelectorAll('.tab-button').forEach(button => { button.classList.remove('active'); });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'documents') { aiTutor.loadDocuments(); }
            else if (tabName === 'quiz') { aiTutor.loadQuizHistory(); }
            else if (tabName === 'study') { aiTutor.loadStudyHistory(); }
            else if (tabName === 'progress') { aiTutor.loadProgress(); }
        }

        function generateQuiz() { aiTutor.generateQuiz(); }
        function submitQuiz() { aiTutor.submitQuiz(); }
        function startStudyTimer() { aiTutor.startStudyTimer(); }
        function stopStudyTimer() { aiTutor.stopStudyTimer(); }

        let aiTutor;
        document.addEventListener('DOMContentLoaded', () => {
            aiTutor = new EnhancedAITutor();
        });
    </script>
</body>
</html>

